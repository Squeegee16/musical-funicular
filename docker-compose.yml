version: "3.9"

networks:
  dispatch-net:

services:

  postgis:
    image: postgis/postgis:16-3.4
    container_name: postgis
    environment:
      POSTGRES_DB: dispatch
      POSTGRES_USER: dispatch
      POSTGRES_PASSWORD: dispatch
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks: [dispatch-net]
    restart: unless-stopped

  audio-linein:
    image: linuxserver/ffmpeg
    container_name: audio-linein
    privileged: true
    devices:
      - /dev/snd:/dev/snd
    volumes:
      - ./data/audio:/audio
    command: >
      -f alsa -i hw:1,0
      -ac 1 -ar 16000
      -f segment
      -segment_time 6
      -reset_timestamps 1
      /audio/linein_%03d.wav
    networks: [dispatch-net]
    restart: unless-stopped

  mic-ingest:
    image: node:20-alpine
    container_name: mic-ingest
    working_dir: /app
    volumes:
      - ./ingest:/app
      - ./data/audio:/audio
    command: node mic-server.js
    ports:
      - "3001:3001"
    networks: [dispatch-net]
    restart: unless-stopped

  whisper:
    image: python:3.11-slim
    container_name: whisper
    working_dir: /app
    volumes:
      - ./whisper:/app
      - ./data/audio:/audio
    command: sh -c "pip install -r requirements.txt && python transcribe.py"
    networks: [dispatch-net]
    restart: unless-stopped

  nlp:
    image: python:3.11-slim
    container_name: nlp
    working_dir: /app
    volumes:
      - ./nlp:/app
    command: python extract.py
    networks: [dispatch-net]
    restart: unless-stopped

  api:
    image: node:20-alpine
    container_name: api
    working_dir: /app
    volumes:
      - ./api:/app
      - ./data/audio:/audio
    command: sh -c "npm install && node server.js"
    ports:
      - "3000:3000"
    networks: [dispatch-net]
    restart: unless-stopped

  frontend:
    image: nginx:alpine
    container_name: frontend
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
    ports:
      - "8080:80"
    networks: [dispatch-net]
    restart: unless-stopped
